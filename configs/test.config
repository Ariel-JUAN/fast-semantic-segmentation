# # # # # # # # # # # # # # # # # # # # # # # #
#                                             #
#   x   MAIN PIPELINE CONFIG FOR ICNET    x   #
#                                             #
# # # # # # # # # # # # # # # # # # # # # # # #

##### $$ MODEL CONFIG $$ #####
model {
    icnet {
        num_classes: 19
        filter_scale: 1.0
        feature_extractor {
            type: 'dilated_resnet50'
        }
        hyperparams {
            batch_norm {
                train: true
                scale: true
                center: true
                decay: 0.9997
                epsilon: 0.001
            }
            regularizer {
                l2_regularizer {
                     weight: 0.0001
                }
            }
            initializer {
                truncated_normal_initializer {
                    stddev: 0.01
                }
            }
        }
        loss {
            classification_loss {
                softmax {}
            }
            use_aux_loss: true
            main_loss_weight: 1.0
            second_branch_loss_weight: 0.4
            first_branch_loss_weight: 0.16
        }
    }
}


##### $$ TRAINING CONFIG $$ #####
train_config: {
    batch_size: 1 # 18
    num_steps: 90000
    # resnet50 checkpoint
    #fine_tune_checkpoint: "tmp/resnet50/resnet_v1_50.ckpt"
    #fine_tune_checkpoint_type: "classification"
    optimizer {
        momentum_optimizer: {
            learning_rate: {
                polynomial_decay_learning_rate {
                    initial_learning_rate: 0.0001
                    decay_steps: 90000
                    power: 0.9
                }
            }
            momentum_optimizer_value: 0.9
        }
    }
    preprocessor_options {
        random_image_crop {
            crop_height: 768
            crop_width: 768
            images_channel_dim: 3
            labels_channel_dim: 1
        }
    }
    batch_queue_capacity: 150 # 150
    num_batch_queue_threads: 8 # 8
    prefetch_queue_capacity: 5 # 5
}
train_input_reader: {
    num_examples: 10 # 2975
    shuffle: true
    tf_record_input_reader {
        input_path: "tmp/cityscapes_train.record"
    }
    num_readers: 32 # 32
}


##### $$ EVAL CONFIG $$ #####
eval_config: {
    num_examples: 10
    max_evals: 10
    fixed_height: 1025
    fixed_width: 2049
}
eval_input_reader: {
    shuffle: false
    num_readers: 1
    tf_record_input_reader {
        input_path: "tmp/cityscapes_train.record"
    }
}
